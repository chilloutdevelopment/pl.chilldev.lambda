<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.9.1 at 2020-03-29 
 | Rendered using Apache Maven Fluido Skin 1.6
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20200329" />
    <meta http-equiv="Content-Language" content="en" />
    <title>WrzasqPl CloudFormation Account handler &#x2013; Using in CloudFormation</title>
    <link rel="stylesheet" href="../css/apache-maven-fluido-1.6.min.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />
      <script type="text/javascript" src="../js/apache-maven-fluido-1.6.min.js"></script>
      </head>
    <body class="topBarDisabled">
      <div class="container-fluid">
      <div id="banner">
        <div class="pull-left"><div id="bannerLeft"><h2>WrzasqPl CloudFormation Account handler</h2>
</div>
</div>
        <div class="pull-right"><a href="https://wrzasq.pl" id="bannerRight"><h2><img src="https://static.wrzasq.pl/images/wrzasqpl.png" alt="Wrzasq.pl"/></h2>
</a></div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
        </ul>
      </div>
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
<ul class="nav nav-list">
          <li class="nav-header">Main</li>
    <li><a href="https://github.com/rafalwrzeszcz-wrzasqpl/pl.wrzasq.lambda/" class="externalLink" title="GitHub project"><span class="none"></span>GitHub project</a>  </li>
    <li><a href="https://wrzasq.pl/" class="externalLink" title="Wrzasq.pl"><span class="none"></span>Wrzasq.pl</a>  </li>
    <li><a href="https://www.facebook.com/wrzasqpl" class="externalLink" title="Wrzasq.pl @ Facebook"><span class="none"></span>Wrzasq.pl @ Facebook</a>  </li>
          <li class="nav-header">Parent Project</li>
    <li><a href="../../index.html" title="WrzasqPl Lambda"><span class="none"></span>WrzasqPl Lambda</a>  </li>
          <li class="nav-header">Guide</li>
    <li class="active"><a href="#"><span class="none"></span>Usage</a>
  </li>
          <li class="nav-header">Project Documentation</li>
    <li><a href="../project-info.html" title="Project Information"><span class="icon-chevron-right"></span>Project Information</a>  </li>
    <li><a href="../project-reports.html" title="Project Reports"><span class="icon-chevron-right"></span>Project Reports</a>  </li>
  </ul>
          <hr />
          <div id="poweredBy">
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
  <a href="https://maven.apache.org/" title="Maven" class="builtBy"><img class="builtBy"  alt="Apache Maven" src="https://maven.apache.org/images/logos/maven-feather.png"    /></a>
<a href="https://wrzasq.pl" title="Wrzasq.pl" class="builtBy"><img class="builtBy"  alt="Wrzasq.pl" src="https://static.wrzasq.pl/images/wrzasqpl.png"    /></a>
              </div>
          </div>
        </div>
        <div id="bodyColumn"  class="span10" >
<!---
# This file is part of the pl.wrzasq.lambda.
#
# @license http://mit-license.org/ The MIT license
# @copyright 2019 © by Rafał Wrzeszcz - Wrzasq.pl.
-->
<h1>Using in CloudFormation</h1>
<p>This resource handler sub-accounts management.</p>
<p><b>Note:</b> When using this handler you have to keep in mind that account is a top-level container of any possible AWS resource including data you store there. Be extremely careful when modifying anything in your account, especially when you try to change something that will result in creating new account to replace old one.</p>
<p><b>Note:</b> From organization level it&#x2019;s impossible to physically delete an account. What is possible is only removing account from organization. After that you will have to terminate account physically using it&#x2019;s root access credentials.</p>
<h1>Required permissions</h1>
<p>lambda-cform-account Lambda needs following permissions:</p>
<ul>

<li>organizations:CreateAccount,</li>
<li>organizations:DescribeAccount,</li>
<li>organizations:DescribeCreateAccountStatus,</li>
<li>organizations:DescribeHandshake,</li>
<li>organizations:InviteAccountToOrganization,</li>
<li>organizations:ListParents,</li>
<li>organizations:MoveAccount,</li>
<li>organizations:RemoveAccountFromOrganization.</li>
</ul>
<p>Additionally you may want to add following policies to it&#x2019;s role:</p>
<ul>

<li>arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole (if you want to see <b>CloudWatch</b> logs of resource handler execution);</li>
<li>arn:aws:iam::aws:policy/AWSXrayWriteOnlyAccess (if you want more detailed tracing, package is built with <b>X-Ray</b> instrumentor).</li>
</ul>
<h1>Properties</h1><section>
<h2><a name="accountId_-_string"></a>accountId - string</h2>
<p>ID of existing account to invite into organization.</p>
<p><b>Note:</b> If you don&#x2019;t specify account ID of an existing account a new one will be created.</p></section><section>
<h2><a name="email_.28required.29_-_string"></a>email (required) - string</h2>
<p>E-mail address to be used for new account creation (will be a login credential for root access).</p></section><section>
<h2><a name="accountName_.28required.29_-_string"></a>accountName (required) - string</h2>
<p>Label of an account.</p></section><section>
<h2><a name="administratorRoleName_-_string"></a>administratorRoleName - string</h2>
<p>Role name for the administration purposes.</p>
<p><b>Note:</b> Only applicable if new account is going to be created. Makes no effect in case of invitation flow.</p>
<h1>Output values</h1>
<p>Deploy handler exposes entire <a class="externalLink" href="https://docs.aws.amazon.com/AWSJavaSDK/latest/javadoc/com/amazonaws/services/organizations/model/Account.html">Account</a> object.</p>
<p><b>Note:</b> Custom resource physical ID is set as an account ID (no matter if invited or created).</p>
<h1>Example</h1>

<div>
<div>
<pre class="source">    AccountManagerRole:
        Type: &quot;AWS::IAM::Role&quot;
        Properties:
            AssumeRolePolicyDocument:
                Statement:
                    -
                        Action: &quot;sts:AssumeRole&quot;
                        Effect: &quot;Allow&quot;
                        Principal:
                            Service:
                                - &quot;lambda.amazonaws.com&quot;
            ManagedPolicyArns:
                - &quot;arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole&quot;
            Policies:
                -
                    PolicyName: &quot;AllowManagingAccounts&quot;
                    PolicyDocument:
                        Version: &quot;2012-10-17&quot;
                        Statement:
                            -
                                Action:
                                    - &quot;organizations:CreateAccount&quot;
                                    - &quot;organizations:DescribeAccount&quot;
                                    - &quot;organizations:DescribeCreateAccountStatus&quot;
                                    - &quot;organizations:DescribeHandshake&quot;
                                    - &quot;organizations:InviteAccountToOrganization&quot;
                                    - &quot;organizations:ListParents&quot;
                                    - &quot;organizations:MoveAccount&quot;
                                    - &quot;organizations:RemoveAccountFromOrganization&quot;
                                Effect: &quot;Allow&quot;
                                Resource:
                                    - &quot;*&quot;

    AccountManager:
        Type: &quot;AWS::Lambda::Function&quot;
        Properties:
            Runtime: &quot;java11&quot;
            Code:
                # put your source bucket
                S3Bucket: &quot;your-bucket&quot;
                S3Key: &quot;lambda-cform-account-1.0.4-standalone.jar&quot;
            Handler: &quot;pl.wrzasq.lambda.cform.account.Handler::handle&quot;
            MemorySize: 256
            Description: &quot;AWS Account manager deployment.&quot;
            Timeout: 300
            TracingConfig:
                Mode: &quot;Active&quot;
            Role: !GetAtt &quot;AccountManagerRole.Arn&quot;

    # notice that there is no accountId in this example
    CreatedAccount:
        Type: &quot;AWS::CloudFormation::CustomResource&quot;
        Properties:
            # reference to deploy function
            ServiceToken: !GetAtt &quot;AccountManager.Arn&quot;
            email: &quot;you+dev@example.com&quot;
            accountName: &quot;dev&quot;
            administratorRoleName: &quot;OrganizationAdmin&quot;
            # assume OrganizationUnit is a resource created by lambda-cform-organization-unit handler
            ouId: !GetAtt &quot;OrganizationUnit.Id&quot;

    InvitedAccount:
        Type: &quot;AWS::CloudFormation::CustomResource&quot;
        Properties:
            # reference to deploy function
            ServiceToken: !GetAtt &quot;AccountManager.Arn&quot;
            accountId: &quot;123456789&quot;
            email: &quot;you+prod@example.com&quot;
            accountName: &quot;prod&quot;
            administratorRoleName: &quot;OrganizationAdmin&quot;
            # assume OrganizationUnit is a resource created by lambda-cform-organization-unit handler
            ouId: !GetAtt &quot;OrganizationUnit.Id&quot;
</pre></div></div></section>
        </div>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>Copyright &copy;2019&#x2013;2020
<a href="https://wrzasq.pl/">Rafał Wrzeszcz - Wrzasq.pl</a>.
All rights reserved.        <li id="publishDate" class="pull-right">Last Published: 2020-03-29</li>
          <li id="projectVersion" class="pull-right">Version: 1.1.2</li>
</p>
        </div>
        </div>
    </footer>
    </body>
</html>
