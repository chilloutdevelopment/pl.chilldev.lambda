<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AccountManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">WrzasqPl CloudFormation Account handler</a> &gt; <a href="index.source.html" class="el_package">pl.wrzasq.lambda.cform.account.service</a> &gt; <span class="el_source">AccountManager.java</span></div><h1>AccountManager.java</h1><pre class="source lang-java linenums">// Generated by delombok at Wed Nov 13 22:11:09 UTC 2019
/*
 * This file is part of the pl.wrzasq.lambda.
 *
 * @license http://mit-license.org/ The MIT license
 * @copyright 2019 © by Rafał Wrzeszcz - Wrzasq.pl.
 */
package pl.wrzasq.lambda.cform.account.service;

import com.amazonaws.services.organizations.AWSOrganizations;
import com.amazonaws.services.organizations.model.Account;
import com.amazonaws.services.organizations.model.AccountNotFoundException;
import com.amazonaws.services.organizations.model.CreateAccountRequest;
import com.amazonaws.services.organizations.model.CreateAccountState;
import com.amazonaws.services.organizations.model.CreateAccountStatus;
import com.amazonaws.services.organizations.model.DescribeAccountRequest;
import com.amazonaws.services.organizations.model.DescribeCreateAccountStatusRequest;
import com.amazonaws.services.organizations.model.DescribeHandshakeRequest;
import com.amazonaws.services.organizations.model.Handshake;
import com.amazonaws.services.organizations.model.HandshakeParty;
import com.amazonaws.services.organizations.model.HandshakePartyType;
import com.amazonaws.services.organizations.model.HandshakeState;
import com.amazonaws.services.organizations.model.InviteAccountToOrganizationRequest;
import com.amazonaws.services.organizations.model.ListParentsRequest;
import com.amazonaws.services.organizations.model.MoveAccountRequest;
import com.amazonaws.services.organizations.model.Parent;
import com.amazonaws.services.organizations.model.RemoveAccountFromOrganizationRequest;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import pl.wrzasq.commons.aws.cloudformation.CustomResourceResponse;
import pl.wrzasq.lambda.cform.account.model.AccountRequest;

/**
 * Organizations API implementation.
 */
public class AccountManager {
    /**
     * Default sleep interval (1 minute).
     */
    private static final long DEFAULT_SLEEP_INTERVAL = 60000;
    /**
     * Logger.
     */
<span class="fc" id="L44">    private Logger logger = LoggerFactory.getLogger(AccountManager.class);</span>
    /**
     * AWS Organizations API client.
     */
    private AWSOrganizations organizations;
    /**
     * Sleep interval for status change checks.
     */
<span class="fc" id="L52">    private long sleepInterval = AccountManager.DEFAULT_SLEEP_INTERVAL;</span>

    /**
     * Initializes object with given Organizations client.
     *
     * @param organizations AWS Organizations client.
     */
<span class="fc" id="L59">    public AccountManager(AWSOrganizations organizations) {</span>
<span class="fc" id="L60">        this.organizations = organizations;</span>
<span class="fc" id="L61">    }</span>

    /**
     * Handles account creation.
     *
     * @param input Resource creation request.
     * @param physicalResourceId Physical ID of existing resource (in this case always null).
     * @return Data about published version.
     */
    public CustomResourceResponse&lt;Account&gt; provision(AccountRequest input, String physicalResourceId) {
<span class="fc bfc" id="L71" title="All 2 branches covered.">        if (physicalResourceId != null) {</span>
<span class="fc" id="L72">            physicalResourceId = resolveExistingAccount(physicalResourceId, input);</span>
        }
        // new account needed
<span class="fc bfc" id="L75" title="All 2 branches covered.">        if (physicalResourceId == null) {</span>
<span class="fc" id="L76">            physicalResourceId = this.initializeAccount(input);</span>
        }
        // check current location in organization structure
<span class="fc" id="L79">        Parent parent = this.organizations.listParents(new ListParentsRequest().withChildId(physicalResourceId)).getParents().get(0);</span>
<span class="fc bfc" id="L80" title="All 2 branches covered.">        if (!parent.getId().equals(input.getOuId())) {</span>
<span class="fc" id="L81">            this.logger.info(&quot;Moving account {} from {} to {}.&quot;, physicalResourceId, parent.getId(), input.getOuId());</span>
<span class="fc" id="L82">            this.organizations.moveAccount(new MoveAccountRequest().withAccountId(physicalResourceId).withSourceParentId(parent.getId()).withDestinationParentId(input.getOuId()));</span>
        }
<span class="fc" id="L84">        Account account = this.organizations.describeAccount(new DescribeAccountRequest().withAccountId(physicalResourceId)).getAccount();</span>
<span class="fc" id="L85">        return new CustomResourceResponse&lt;&gt;(account, physicalResourceId);</span>
    }

    /**
     * Handles organization deletion.
     *
     * @param input Resource delete request.
     * @param physicalResourceId Physical ID of existing resource (if present).
     * @return Empty response.
     */
    public CustomResourceResponse&lt;Account&gt; delete(AccountRequest input, String physicalResourceId) {
<span class="fc" id="L96">        this.organizations.removeAccountFromOrganization(new RemoveAccountFromOrganizationRequest().withAccountId(physicalResourceId));</span>
<span class="fc" id="L97">        this.logger.info(&quot;Removed account {} from organization - keep in mind that account still exists and needs to be terminated manually!&quot;, physicalResourceId);</span>
<span class="fc" id="L98">        return new CustomResourceResponse&lt;&gt;(null, physicalResourceId);</span>
    }

    /**
     * Manages new account for organization.
     *
     * @param input Account specification.
     * @return Account ID.
     */
    private String initializeAccount(AccountRequest input) {
<span class="fc bfc" id="L108" title="All 2 branches covered.">        return input.getAccountId() == null ? this.createAccount(input.getEmail(), input.getAccountName(), input.getAdministratorRoleName()) : this.inviteAccount(input.getAccountId());</span>
    }

    /**
     * Creates plain, new account.
     *
     * @param email E-mail address for root access.
     * @param name Account label.
     * @param roleName Administration role name.
     * @return Account ID.
     */
    private String createAccount(String email, String name, String roleName) {
<span class="fc" id="L120">        CreateAccountStatus status = this.organizations.createAccount(new CreateAccountRequest().withEmail(email).withAccountName(name).withRoleName(roleName)).getCreateAccountStatus();</span>
<span class="fc" id="L121">        this.logger.info(&quot;New account creation initialized for {} ({}).&quot;, email, name);</span>
        // wait until account creation process is finished
<span class="fc bfc" id="L123" title="All 2 branches covered.">        while (CreateAccountState.fromValue(status.getState()) == CreateAccountState.IN_PROGRESS) {</span>
<span class="fc" id="L124">            this.logger.info(&quot;Account creation {} in progress…&quot;, name);</span>
<span class="fc" id="L125">            this.sleep();</span>
<span class="fc" id="L126">            status = this.organizations.describeCreateAccountStatus(new DescribeCreateAccountStatusRequest().withCreateAccountRequestId(status.getId())).getCreateAccountStatus();</span>
        }
<span class="fc" id="L128">        this.logger.info(&quot;Account creation status: {}.&quot;, status.getState());</span>
<span class="fc bfc" id="L129" title="All 2 branches covered.">        if (CreateAccountState.fromValue(status.getState()) == CreateAccountState.SUCCEEDED) {</span>
<span class="fc" id="L130">            return status.getAccountId();</span>
        } else {
<span class="fc" id="L132">            throw new IllegalStateException(String.format(&quot;Failed to create account for %s (%s) - reason: %s.&quot;, email, name, status.getFailureReason()));</span>
        }
    }

    /**
     * Invites existing account to organization.
     *
     * @param accountId Existing account ID.
     * @return Account ID.
     */
    private String inviteAccount(String accountId) {
<span class="fc" id="L143">        Handshake handshake = this.organizations.inviteAccountToOrganization(new InviteAccountToOrganizationRequest().withTarget(new HandshakeParty().withType(HandshakePartyType.ACCOUNT).withId(accountId))).getHandshake();</span>
<span class="fc" id="L144">        this.logger.info(&quot;Invited account {} to the organization&quot;, accountId);</span>
<span class="fc bfc" id="L145" title="All 2 branches covered.">        while (HandshakeState.fromValue(handshake.getState()) == HandshakeState.REQUESTED) {</span>
<span class="fc" id="L146">            this.logger.info(&quot;Account {} handshake in progress…&quot;, accountId);</span>
<span class="fc" id="L147">            this.sleep();</span>
<span class="fc" id="L148">            handshake = this.organizations.describeHandshake(new DescribeHandshakeRequest().withHandshakeId(handshake.getId())).getHandshake();</span>
        }
<span class="fc bfc" id="L150" title="All 2 branches covered.">        if (HandshakeState.fromValue(handshake.getState()) == HandshakeState.ACCEPTED) {</span>
<span class="fc" id="L151">            return accountId;</span>
        } else {
<span class="fc" id="L153">            throw new IllegalStateException(String.format(&quot;Failed to invite account %s - status: %s.&quot;, accountId, handshake.getState()));</span>
        }
    }

    /**
     * Resolves ID of existing resource.
     *
     * @param accountId Currently provisioned ID.
     * @param input Desired account specification.
     * @return Resolved account ID.
     */
    private String resolveExistingAccount(String accountId, AccountRequest input) {
        try {
<span class="fc" id="L166">            Account account = this.organizations.describeAccount(new DescribeAccountRequest().withAccountId(accountId)).getAccount();</span>
<span class="fc bfc" id="L167" title="All 4 branches covered.">            if (input.getEmail().equals(account.getEmail()) &amp;&amp; input.getAccountName().equals(account.getName())) {</span>
<span class="fc" id="L168">                return account.getId();</span>
            } else {
<span class="fc" id="L170">                this.logger.warn(&quot;Account {} core data changed - will re-create account!&quot;, account.getArn());</span>
<span class="fc" id="L171">                return null;</span>
            }
<span class="fc" id="L173">        } catch (AccountNotFoundException error) {</span>
<span class="fc" id="L174">            this.logger.warn(&quot;Account {} not found - resolving to new account.&quot;, accountId);</span>
<span class="fc" id="L175">            return null;</span>
        }
    }

    /**
     * Performs a wait.
     */
    private void sleep() {
        try {
<span class="fc" id="L184">            Thread.sleep(this.sleepInterval);</span>
<span class="nc" id="L185">        } catch (InterruptedException error) {</span>
<span class="nc" id="L186">            this.logger.error(&quot;Wait interval interrupted.&quot;, error);</span>
<span class="fc" id="L187">        }</span>
<span class="fc" id="L188">    }</span>

    /**
     * Sleep interval for status change checks.
     */
    @SuppressWarnings(&quot;all&quot;)
    @lombok.Generated
    public void setSleepInterval(final long sleepInterval) {
        this.sleepInterval = sleepInterval;
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>