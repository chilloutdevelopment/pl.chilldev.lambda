<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.9.2 at 2020-06-13 
 | Rendered using Apache Maven Fluido Skin 1.6
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20200613" />
    <meta http-equiv="Content-Language" content="en" />
    <title>WrzasqPl CodePipeline automation macro &#x2013; Required permissions</title>
    <link rel="stylesheet" href="../css/apache-maven-fluido-1.6.min.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />
      <script type="text/javascript" src="../js/apache-maven-fluido-1.6.min.js"></script>
      </head>
    <body class="topBarDisabled">
      <div class="container-fluid">
      <div id="banner">
        <div class="pull-left"><div id="bannerLeft"><h2>WrzasqPl CodePipeline automation macro</h2>
</div>
</div>
        <div class="pull-right"><a href="https://wrzasq.pl" id="bannerRight"><h2><img src="https://static.wrzasq.pl/images/wrzasqpl.png" alt="Wrzasq.pl"/></h2>
</a></div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
        </ul>
      </div>
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
<ul class="nav nav-list">
          <li class="nav-header">Main</li>
    <li><a href="https://github.com/rafalwrzeszcz-wrzasqpl/pl.wrzasq.lambda/" class="externalLink" title="GitHub project"><span class="none"></span>GitHub project</a>  </li>
    <li><a href="https://wrzasq.pl/" class="externalLink" title="Wrzasq.pl"><span class="none"></span>Wrzasq.pl</a>  </li>
    <li><a href="https://www.facebook.com/wrzasqpl" class="externalLink" title="Wrzasq.pl @ Facebook"><span class="none"></span>Wrzasq.pl @ Facebook</a>  </li>
          <li class="nav-header">Parent Project</li>
    <li><a href="../../index.html" title="WrzasqPl Lambda"><span class="none"></span>WrzasqPl Lambda</a>  </li>
          <li class="nav-header">Guide</li>
    <li><a href="../guide/pipeline.html" title="CI/CD pipeline"><span class="none"></span>CI/CD pipeline</a>  </li>
    <li class="active"><a href="#"><span class="none"></span>Usage</a>
  </li>
          <li class="nav-header">Project Documentation</li>
    <li><a href="../project-info.html" title="Project Information"><span class="icon-chevron-right"></span>Project Information</a>  </li>
    <li><a href="../project-reports.html" title="Project Reports"><span class="icon-chevron-right"></span>Project Reports</a>  </li>
  </ul>
          <hr />
          <div id="poweredBy">
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
  <a href="https://maven.apache.org/" title="Maven" class="builtBy"><img class="builtBy"  alt="Apache Maven" src="https://maven.apache.org/images/logos/maven-feather.png"    /></a>
<a href="https://wrzasq.pl" title="Wrzasq.pl" class="builtBy"><img class="builtBy"  alt="Wrzasq.pl" src="https://static.wrzasq.pl/images/wrzasqpl.png"    /></a>
              </div>
          </div>
        </div>
        <div id="bodyColumn"  class="span10" >
<!---
# This file is part of the pl.wrzasq.lambda.
#
# @license http://mit-license.org/ The MIT license
# @copyright 2020 © by Rafał Wrzeszcz - Wrzasq.pl.
-->
<h1>Required permissions</h1>
<p><code>lambda-macro-pipeline-multistagecd</code> Needs no specific permissions, you may want to add following policies to it&#x2019;s role:</p>
<ul>

<li><code>arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole</code> (if you want to see <b>CloudWatch</b> logs of resource handler execution);</li>
<li><code>arn:aws:iam::aws:policy/AWSXrayWriteOnlyAccess</code> (if you want more detailed tracing, package is built with <b>X-Ray</b> instrumentor).</li>
</ul>
<h1>Definition</h1>
<p>Section: <code>Pipeline</code>.</p>
<p>This macro operates on dedicated template section, <code>Pipeline</code>. It has sub-sections to set different aspects of CI/CD pipeline.</p><section>
<h2><a name="config"></a><code>config</code></h2>
<p>Configuration section is optional, and allows to customize managed pipeline. If omitted, default configuration is applied.</p><section>
<h3><a name="resourceName_-_string_.28default:_Pipeline.29"></a><code>resourceName</code> - string (default: <code>Pipeline</code>)</h3>
<p>Managed pipeline resource name.</p></section><section>
<h3><a name="hasCheckoutStepParameterName_-_string_.28default:_HasCheckoutStep.29"></a><code>hasCheckoutStepParameterName</code> - string (default: <code>HasCheckoutStep</code>)</h3>
<p>Name of parameter that controls existence of initial checkout steps.</p></section><section>
<h3><a name="hasNextStageParameterName_-_string_.28default:_HasNextStage.29"></a><code>hasNextStageParameterName</code> - string (default: <code>HasNextStage</code>)</h3>
<p>Name of parameter that controls existence of stage promotion steps.</p></section><section>
<h3><a name="requiresManualApprovalParameterName_-_string_.28default:_RequiresManualApproval.29"></a><code>requiresManualApprovalParameterName</code> - string (default: <code>RequiresManualApproval</code>)</h3>
<p>Name of parameter that controls existence of manual approval step.</p></section><section>
<h3><a name="hasCheckoutStepConditionName_-_string_.28default:_HasCheckoutStep.29"></a><code>hasCheckoutStepConditionName</code> - string (default: <code>HasCheckoutStep</code>)</h3>
<p>Name of condition that controls existence of initial checkout steps (it reflects parameter value).</p></section><section>
<h3><a name="hasNextStageConditionName_-_string_.28default:_HasNextStage.29"></a><code>hasNextStageConditionName</code> - string (default: <code>HasNextStage</code>)</h3>
<p>Name of parameter that controls existence of stage promotion steps (it reflects parameter value).</p></section><section>
<h3><a name="requiresManualApprovalConditionName_-_string_.28default:_RequiresManualApproval.29"></a><code>requiresManualApprovalConditionName</code> - string (default: <code>RequiresManualApproval</code>)</h3>
<p>Name of parameter that controls existence of manual approval step (it reflects parameter value and considers also next stage condition).</p></section><section>
<h3><a name="webhookAuthenticationType_-_string_.7C_object"></a><code>webhookAuthenticationType</code> - string | object</h3>
<p>Authentication type for Git webhook. If not specified, webhook will not be created.</p></section><section>
<h3><a name="webhookSecretToken_-_string_.7C_object"></a><code>webhookSecretToken</code> - string | object</h3>
<p>Webhook secret token. If not specified, webhook will not be created. This setting can be a string, but also complex construct (like intrinsic function call)</p></section></section><section>
<h2><a name="properties"></a><code>properties</code></h2>
<p>Any properties that will be passed directly to <a class="externalLink" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-codepipeline-pipeline.html">AWS::CodePipeline::Pipeline</a> resource.</p></section><section>
<h2><a name="sources"></a><code>sources</code></h2>
<p>Definition initial sources. These sources are used as inputs for the initial stage (based on <code>HasCheckoutStage</code> parameter). For any further stage previous stage artifacts are used - for that see <b>artifacts</b> section below.</p>
<p>Each source is an entry with key being used as action name and implicitly output artifact name. Entry content is definition of CodePipeline action:</p>

<div class="source">
<div class="source"><pre class="prettyprint">    sources:
        checkout:
            ActionTypeId:
                Category: &quot;Source&quot;
                Owner: &quot;ThirdParty&quot;
                Provider: &quot;GitHub&quot;
                Version: &quot;1&quot;
            Configuration:
                Owner: &quot;yourorganization&quot;
                Repo: &quot;reponame&quot;
                Branch:
                    Ref: &quot;branch&quot;
                OAuthToken: &quot;{{resolve:secretsmanager:GitHub:SecretString:OAuthToken}}&quot;
                PollForSourceChanges: false
</pre></div></div>
</section><section>
<h2><a name="stages"></a><code>stages</code></h2>
<p>Content of the pipeline. It is mapped into final <code>AWS::CodePipeline::Pipeline</code> stages property elements. However there are some simplifications:</p>
<ul>

<li>unless not strictly required by your pipeline, you don&#x2019;t need to specify <code>RunOrder</code> property (it will be calculated based on artifacts dependencies);</li>
<li><code>InputArtifacts</code> and <code>OutputArtifacts</code> are list of simple strings (not objects with <code>Name</code> property);</li>
<li>in <code>ActionTypeId</code> properties <code>Owner</code> and <code>Version</code> are not required (defaults to <code>AWS</code> and <code>1</code> respectively);</li>
<li>for <code>CloudFormation</code> deploy steps no <code>ActionTypeId</code> is required at all, this is the default action;</li>
<li>actions can not be conditional, but entire stages can be, by specifying <code>Condition</code> property of stage;</li>
<li>for <code>CloudFormation</code> deploy action input artifacts are detected automatically for <code>TemplatePath</code> and <code>TemplateConfiguration</code> properties if they are plain strings (it&#x2019;s still possible to define additional artifacts explicitly).</li>
</ul></section><section>
<h2><a name="artifacts"></a><code>artifacts</code></h2>
<p>Pipeline artifacts are artifacts of pipeline actions that you want to promote to next deployment stage. The same list will be used to build sources list of non-initial stage, binding deployment stages to chain after promotion (successful execution of previous stage). Right now only <b>S3</b> is supported as artifacts transition (deploy action is used to push artifacts into next stage and source is defined in next stage pipeline).</p>
<h1>Example</h1>

<div class="source">
<div class="source"><pre class="prettyprint">Transform:
    - &quot;WrzasqPlMultistagePipeline&quot;

Parameters:
    HasCheckoutStep:
        Type: String
        Default: 'false'
        AllowedValues:
            - 'true'
            - 'false'

    HasNextStage:
        Type: String
        Default: 'false'
        AllowedValues:
            - 'true'
            - 'false'

    RequiresManualApproval:
        Type: String
        Default: 'true'
        AllowedValues:
            - 'true'
            - 'false'

Resources:
    BuildProject:
        Type: &quot;AWS::CodeBuild::Project&quot;

Pipeline:
    config:
        resourceName: &quot;DeployPipeline&quot;

    properties:
        RestartExecutionOnUpdate: true
        RoleArn: &quot;arn:aws:iam::765719665682:role/service-role/test&quot;
        ArtifactStore:
            Type: &quot;S3&quot;
            Location: &quot;test-local-lambda&quot;

    sources:
        checkout:
            ActionTypeId:
                Category: &quot;Source&quot;
                Owner: &quot;AWS&quot;
                Provider: &quot;S3&quot;
                Version: &quot;1&quot;
            Configuration:
                S3Bucket: &quot;test-local-lambda&quot;
                S3ObjectKey: &quot;pl.wrzasq.lambda/checkout.zip&quot;

    stages:
        -
            # this is example of conditional stage
            Name: &quot;Build&quot;
            Condition: &quot;HasCheckoutStep&quot;
            Actions:
                -
                    Name: &quot;Build&quot;
                    ActionTypeId:
                        Category: &quot;Build&quot;
                        Provider: &quot;CodeBuild&quot;
                    Configuration:
                        ProjectName: !Ref &quot;BuildProject&quot;
                        EnvironmentVariables: |
                            [
                                {
                                    &quot;name&quot;: &quot;VERSION_STRING&quot;,
                                    &quot;value&quot;: &quot;#{codepipeline.PipelineExecutionId}&quot;
                                }
                            ]
                    InputArtifacts:
                        - &quot;checkout&quot;
                    OutputArtifacts:
                        - &quot;build&quot;
        -
            Name: &quot;Deploy&quot;
            Actions:
                -
                    Name: &quot;Database&quot;
                    Configuration:
                        ActionMode: &quot;CREATE_UPDATE&quot;
                        StackName: !Sub &quot;${ServiceName}-db&quot;
                        RoleArn: !ImportValue &quot;infra:DeployRole:Arn&quot;
                        Capabilities: &quot;CAPABILITY_NAMED_IAM&quot;
                        # `build` artifact will automatically be detected
                        TemplatePath: &quot;build::cloudformation/db.yaml&quot;
                        # since this is not a plain string value `templates` artifact needs to be added manually
                        TemplateConfiguration: !Sub &quot;templates::cloudformation/config-${EnvironmentName}.json&quot;
                        OutputFileName: &quot;out.json&quot;
                    InputArtifacts:
                        - &quot;templates&quot;
                    OutputArtifacts:
                        - &quot;database&quot;
                -
                    Name: &quot;EventsListenerLambda&quot;
                    Configuration:
                        ActionMode: &quot;CREATE_UPDATE&quot;
                        StackName: &quot;events-recorder&quot;
                        Capabilities: &quot;CAPABILITY_NAMED_IAM,CAPABILITY_AUTO_EXPAND&quot;
                        TemplatePath: &quot;templates::cloudformation/events-listener.yaml&quot;
                        TemplateConfiguration: &quot;templates::cloudformation/config-dev.json&quot;
                        OutputFileName: &quot;out.json&quot;
                        ParameterOverrides: |
                            {
                                &quot;EventsTableName&quot;: { &quot;Fn::GetParam&quot;: [&quot;database&quot;, &quot;out.json&quot;, &quot;EventsTableName&quot;] },
                                &quot;EventsTableArn&quot;: { &quot;Fn::GetParam&quot;: [&quot;database&quot;, &quot;out.json&quot;, &quot;EventsTableArn&quot;] }
                            }
                    InputArtifacts:
                        - &quot;database&quot;
                    OutputArtifacts:
                        - &quot;events-listener&quot;
                -
                    Name: &quot;AuthorizerLambda&quot;
                    Configuration:
                        ActionMode: &quot;CREATE_UPDATE&quot;
                        StackName: &quot;authorizer&quot;
                        Capabilities: &quot;CAPABILITY_NAMED_IAM,CAPABILITY_AUTO_EXPAND&quot;
                        TemplatePath: &quot;templates::cloudformation/authorizer.yaml&quot;
                        OutputFileName: &quot;out.json&quot;
                    OutputArtifacts:
                        - &quot;authorizer&quot;
                -
                    Name: &quot;API&quot;
                    Configuration:
                        ActionMode: &quot;CREATE_UPDATE&quot;
                        StackName: &quot;api&quot;
                        Capabilities: &quot;CAPABILITY_NAMED_IAM,CAPABILITY_AUTO_EXPAND&quot;
                        TemplatePath: &quot;templates::cloudformation/api.yaml&quot;
                        OutputFileName: &quot;out.json&quot;
                        ParameterOverrides: |
                            {
                                &quot;AuthorizerLambda&quot;: { &quot;Fn::GetParam&quot;: [&quot;authorizer&quot;, &quot;out.json&quot;, &quot;LambdaArn&quot;] },
                                &quot;EventsListenerLambda&quot;: { &quot;Fn::GetParam&quot;: [&quot;events-listener&quot;, &quot;out.json&quot;, &quot;LambdaArn&quot;] }
                            }
                    InputArtifacts:
                        - &quot;authorizer&quot;
                        - &quot;events-listener&quot;

    artifacts:
        build:
            sourceBucketName: !ImportValue &quot;wrzasq:ArtifactsBucket:Name&quot;
            nextBucketName: !Ref &quot;NextStageBucketName&quot;
            objectKey: &quot;pl.wrzasq.lambda/build.zip&quot;
        templates:
            sourceBucketName: !ImportValue &quot;wrzasq:ArtifactsBucket:Name&quot;
            nextBucketName: !Ref &quot;NextStageBucketName&quot;
            objectKey: &quot;pl.wrzasq.lambda/templates.zip&quot;
</pre></div></div>

<h1>Installation</h1>

<div class="source">
<div class="source"><pre class="prettyprint">    MacroFunctionRole:
        Type: &quot;AWS::IAM::Role&quot;
        Properties:
            AssumeRolePolicyDocument:
                Statement:
                    -
                        Action: &quot;sts:AssumeRole&quot;
                        Effect: &quot;Allow&quot;
                        Principal:
                            Service:
                                - &quot;lambda.amazonaws.com&quot;
            ManagedPolicyArns:
                - &quot;arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole&quot;

    MacroFunction:
        Type: &quot;AWS::Serverless::Function&quot;
        Properties:
            Runtime: &quot;java11&quot;
            Code:
                # put your source bucket
                S3Bucket: &quot;your-bucket&quot;
                S3Key: &quot;lambda-macro-pipeline-multistagecd-1.1.2-standalone.jar&quot;
            Handler: &quot;pl.wrzasq.lambda.macro.pipeline.multistagecd.Handler::handleRequest&quot;
            MemorySize: 256
            Description: &quot;Custom CloudFormation macro handler.&quot;
            Timeout: 300
            TracingConfig:
                Mode: &quot;Active&quot;
            Role: !GetAtt &quot;MacroFunctionRole.Arn&quot;

    Macro:
        Type: &quot;AWS::CloudFormation::Macro&quot;
        Properties:
            Name: &quot;WrzasqPlMultistagePipeline&quot;
            FunctionName: !GetAtt &quot;MacroFunction.Arn&quot;
</pre></div></div></section>
        </div>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>Copyright &copy;2020
<a href="https://wrzasq.pl/">Rafał Wrzeszcz - Wrzasq.pl</a>.
All rights reserved.        <li id="publishDate" class="pull-right">Last Published: 2020-06-13</li>
          <li id="projectVersion" class="pull-right">Version: 1.1.8</li>
</p>
        </div>
        </div>
    </footer>
    </body>
</html>
