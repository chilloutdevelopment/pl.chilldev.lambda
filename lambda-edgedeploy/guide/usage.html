<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.8.1 at 2019-03-28 
 | Rendered using Apache Maven Fluido Skin 1.6
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20190328" />
    <meta http-equiv="Content-Language" content="en" />
    <title>WrzasqPl Lambda@Edge deploy &#x2013; Using in CloudFormation</title>
    <link rel="stylesheet" href="../css/apache-maven-fluido-1.6.min.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />
      <script type="text/javascript" src="../js/apache-maven-fluido-1.6.min.js"></script>
      </head>
    <body class="topBarDisabled">
      <div class="container-fluid">
      <div id="banner">
        <div class="pull-left"><div id="bannerLeft"><h2>WrzasqPl Lambda@Edge deploy</h2>
</div>
</div>
        <div class="pull-right"><a href="https://wrzasq.pl" id="bannerRight"><h2><img src="https://static.wrzasq.pl/images/wrzasqpl.png" alt="Wrzasq.pl"/></h2>
</a></div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
        </ul>
      </div>
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
<ul class="nav nav-list">
          <li class="nav-header">Main</li>
    <li><a href="https://github.com/rafalwrzeszcz-wrzasqpl/pl.wrzasq.lambda/" class="externalLink" title="GitHub project"><span class="none"></span>GitHub project</a>  </li>
    <li><a href="https://wrzasq.pl/" class="externalLink" title="Wrzasq.pl"><span class="none"></span>Wrzasq.pl</a>  </li>
    <li><a href="https://www.facebook.com/wrzasqpl" class="externalLink" title="Wrzasq.pl @ Facebook"><span class="none"></span>Wrzasq.pl @ Facebook</a>  </li>
          <li class="nav-header">Parent Project</li>
    <li><a href="../../index.html" title="WrzasqPl Lambda"><span class="none"></span>WrzasqPl Lambda</a>  </li>
          <li class="nav-header">Guide</li>
    <li class="active"><a href="#"><span class="none"></span>Usage</a>
  </li>
    <li><a href="../guide/delete.html" title="Failing delete"><span class="none"></span>Failing delete</a>  </li>
    <li><a href="../guide/config.html" title="Configuration"><span class="none"></span>Configuration</a>  </li>
          <li class="nav-header">Project Documentation</li>
    <li><a href="../project-info.html" title="Project Information"><span class="icon-chevron-right"></span>Project Information</a>  </li>
    <li><a href="../project-reports.html" title="Project Reports"><span class="icon-chevron-right"></span>Project Reports</a>  </li>
  </ul>
          <hr />
          <div id="poweredBy">
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
  <a href="https://maven.apache.org/" title="Maven" class="builtBy"><img class="builtBy"  alt="Apache Maven" src="https://maven.apache.org/images/logos/maven-feather.png"    /></a>
<a href="https://wrzasq.pl" title="Wrzasq.pl" class="builtBy"><img class="builtBy"  alt="Wrzasq.pl" src="https://static.wrzasq.pl/images/wrzasqpl.png"    /></a>
              </div>
          </div>
        </div>
        <div id="bodyColumn"  class="span10" >
<!---
# This file is part of the pl.wrzasq.lambda.
#
# @license http://mit-license.org/ The MIT license
# @copyright 2018 - 2019 © by Rafał Wrzeszcz - Wrzasq.pl.
-->
<h1>Using in CloudFormation</h1>
<p>Purpose of this <b>Lambda</b> is to allow deploying any other package in <tt>us-east-1</tt> region (regardless of your current execution region). This allows to use desired package as <b>Lambda@Edge</b> handler in <a class="externalLink" href="https://aws.amazon.com/cloudfront/"><b>CloudFront</b></a>. Additionally, during deployment ZIP package it injects additional file with deployment time configuration.</p>
<h1>Required permissions</h1>
<p><tt>lambda-edgedeploy</tt> Lambda needs following permissions:</p>
<ul>

<li>read access to <b>S3</b> location where your deployment package is located;</li>
<li>Lambda management permissions;</li>
<li><tt>iam:PassRole</tt> permission to pass role for the target <b>Lambda@Edge</b>.</li>
</ul>
<p>Additionally you may want to add following policies to it&#x2019;s role:</p>
<ul>

<li><tt>arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole</tt> (if you want to see <b>CloudWatch</b> logs of resource handler execution);</li>
<li><tt>arn:aws:iam::aws:policy/AWSXrayWriteOnlyAccess</tt> (if you want more detailed tracing, package is built with <b>X-Ray</b> instrumentor).</li>
</ul>
<h1>Properties</h1>
<div class="section">
<h2><a name="functionName_.28required.29_-_string"></a><tt>functionName</tt> (required) - string</h2>
<p>Specified destination function name.</p>
<p><b>Note:</b> Even though <b>Lambda</b> is region-scoped, keep in mind that deploying <b>Lambda@Edge</b> always targets <tt>us-east-1</tt>, which means it&#x2019;s good idea to use region name (eg. <tt>AWS::Region</tt>) in function name.</p></div>
<div class="section">
<h2><a name="functionDescription_-_string"></a><tt>functionDescription</tt> - string</h2>
<p>Function description.</p></div>
<div class="section">
<h2><a name="roleArn_.28required.29_-_ARN"></a><tt>roleArn</tt> (required) - ARN</h2>
<p><a class="externalLink" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-iam-role.html">IAM role</a> <b>ARN</b>.</p></div>
<div class="section">
<h2><a name="runtime_-_string"></a><tt>runtime</tt> - string</h2>
<p><b>Node.js</b> runtime to use (keep in mind that <b>Lambda@Edge</b> only supports <b>Node.js</b> runtimes). By default <b>8.10</b> is used.</p></div>
<div class="section">
<h2><a name="handler_.28required.29_-_string"></a><tt>handler</tt> (required) - string</h2>
<p>Entry point handler for invoking function.</p></div>
<div class="section">
<h2><a name="memory_.28required.29_-_integer"></a><tt>memory</tt> (required) - integer</h2>
<p>Memory (in MBs) allocated for target function.</p></div>
<div class="section">
<h2><a name="timeout_.28required.29_-_integer"></a><tt>timeout</tt> (required) - integer</h2>
<p>Timeout (in seconds) for single invocation.</p></div>
<div class="section">
<h2><a name="tracingMode_-_string"></a><tt>tracingMode</tt> - string</h2>
<p><b>X-Ray</b> tracing mode. Can be either <tt>PassThrough</tt> (default value) or <tt>Active</tt>.</p></div>
<div class="section">
<h2><a name="packageBucket_.28required.29_-_string"></a><tt>packageBucket</tt> (required) - string</h2>
<p><b>S3</b> bucket from which your destination Lambda package is located.</p></div>
<div class="section">
<h2><a name="packageKey_.28required.29_-_string"></a><tt>packageKey</tt> (required) - string</h2>
<p>Key, where your target Lambda package is stored in <b>S3</b>.</p></div>
<div class="section">
<h2><a name="configFile_-_string"></a><tt>configFile</tt> - string</h2>
<p>Name under which deployment configuration will be exposed in your package (by default it&#x2019;s <tt>config.json</tt>).</p></div>
<div class="section">
<h2><a name="config_-_key-value_object"></a><tt>config</tt> - key-value object</h2>
<p>Any configuration options that should be added at deploy-time to your package.</p>
<h1>Output values</h1>
<p>Deploy handler exposes entire <a class="externalLink" href="https://docs.aws.amazon.com/AWSJavaSDK/latest/javadoc/com/amazonaws/services/lambda/model/PublishVersionResult.html">PublishVersionResult</a> object. Most important from it is a <tt>FunctionArn</tt> property, which refers to a <b>published version of Lambda</b> (which means it includes version classifier). It&#x2019;s the property that you can use to assign published version as <b>CloudFront</b> association (see example below).</p>
<p><b>Note:</b> Custom resource physical ID is set as deployed function <a class="externalLink" href="https://docs.aws.amazon.com/general/latest/gr/aws-arns-and-namespaces.html">ARN</a> (master function, not published version).</p>
<h1>Example</h1>

<div>
<div>
<pre class="source">    CloudFrontDistribution:
        Type: &quot;AWS::CloudFront::Distribution&quot;
        Properties:
            DistributionConfig:
                Origins:
                    -
                        Id: &quot;frontend-service&quot;
                        # origin configuration
                DefaultCacheBehavior:
                    TargetOriginId: &quot;frontend-service&quot;
                    AllowedMethods:
                        - &quot;DELETE&quot;
                        - &quot;GET&quot;
                        - &quot;HEAD&quot;
                        - &quot;OPTIONS&quot;
                        - &quot;PATCH&quot;
                        - &quot;POST&quot;
                        - &quot;PUT&quot;
                    CachedMethods:
                        - &quot;GET&quot;
                        - &quot;HEAD&quot;
                        - &quot;OPTIONS&quot;
                    Compress: false
                    ViewerProtocolPolicy: &quot;allow-all&quot;
                    LambdaFunctionAssociations:
                        -
                            EventType: &quot;origin-request&quot;
                            # here is the Lambda@Edge integration point
                            LambdaFunctionARN: !GetAtt &quot;EdgeFunction.FunctionArn&quot;
                Enabled: true

    # this role will be used by target Lambda - Lambda@Edge
    EdgeFunctionRole:
        Type: &quot;AWS::IAM::Role&quot;
        Properties:
            AssumeRolePolicyDocument:
                Statement:
                    -
                        Action: &quot;sts:AssumeRole&quot;
                        Effect: &quot;Allow&quot;
                        Principal:
                            Service:
                                - &quot;edgelambda.amazonaws.com&quot;
                                - &quot;lambda.amazonaws.com&quot;
            ManagedPolicyArns:
                - &quot;arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole&quot;

    # this role will be used by deploy Lambda
    EdgeDeployRole:
        Type: &quot;AWS::IAM::Role&quot;
        Properties:
            AssumeRolePolicyDocument:
                Statement:
                    -
                        Action: &quot;sts:AssumeRole&quot;
                        Effect: &quot;Allow&quot;
                        Principal:
                            Service:
                                - &quot;lambda.amazonaws.com&quot;
            Policies:
                -
                    PolicyName: &quot;AllowManagingLambdas&quot;
                    PolicyDocument:
                        Version: &quot;2012-10-17&quot;
                        Statement:
                            -
                                Action:
                                    - &quot;s3:GetBucketLocation&quot;
                                    - &quot;s3:GetObject&quot;
                                    - &quot;s3:ListBucket&quot;
                                Effect: &quot;Allow&quot;
                                Resource:
                                    # put your source bucket here
                                    - &quot;arn:aws:s3:::wrzasqpl-repository&quot;
                                    - &quot;arn:aws:s3:::wrzasqpl-repository/*&quot;
                -
                    PolicyName: &quot;AllowManagingLambdas&quot;
                    PolicyDocument:
                        Version: &quot;2012-10-17&quot;
                        Statement:
                            -
                                Action:
                                    - &quot;iam:CreateServiceLinkedRole&quot;
                                    - &quot;lambda:CreateFunction&quot;
                                    - &quot;lambda:ListTags&quot;
                                    - &quot;lambda:TagResource&quot;
                                    - &quot;lambda:UntagResource&quot;
                                    - &quot;lambda:UpdateFunctionConfiguration&quot;
                                Effect: &quot;Allow&quot;
                                Resource:
                                    - !Sub &quot;*&quot;
                -
                    PolicyName: &quot;AllowManagingEdgeLambdas&quot;
                    PolicyDocument:
                        Version: &quot;2012-10-17&quot;
                        Statement:
                            -
                                Action:
                                    - &quot;lambda:AddPermission&quot;
                                    - &quot;lambda:CreateAlias&quot;
                                    - &quot;lambda:DeleteAlias&quot;
                                    - &quot;lambda:DeleteFunction&quot;
                                    - &quot;lambda:GetAlias&quot;
                                    - &quot;lambda:GetFunction&quot;
                                    - &quot;lambda:GetFunctionConfiguration&quot;
                                    - &quot;lambda:GetPolicy&quot;
                                    - &quot;lambda:ListVersionsByFunction&quot;
                                    - &quot;lambda:PublishVersion&quot;
                                    - &quot;lambda:RemovePermission&quot;
                                    - &quot;lambda:UpdateAlias&quot;
                                    - &quot;lambda:UpdateFunctionCode&quot;
                                Effect: &quot;Allow&quot;
                                Resource:
                                    - !Sub &quot;arn:aws:lambda:us-east-1:${AWS::AccountId}:function:*&quot;
                -
                    PolicyName: &quot;AllowPassingEdgeRole&quot;
                    PolicyDocument:
                        Version: &quot;2012-10-17&quot;
                        Statement:
                            -
                                Action:
                                    - &quot;iam:PassRole&quot;
                                Effect: &quot;Allow&quot;
                                Resource:
                                    - !GetAtt &quot;EdgeFunctionRole.Arn&quot;

    EdgeDeploy:
        Type: &quot;AWS::Lambda::Function&quot;
        Properties:
            Runtime: &quot;java8&quot;
            Code:
                # put your source bucket
                S3Bucket: &quot;your-bucket&quot;
                S3Key: &quot;lambda-edgedeploy-1.0.1-standalone.jar&quot;
            Handler: &quot;pl.wrzasq.lambda.edgedeploy.Handler::handle&quot;
            MemorySize: 256
            Description: &quot;Lambda@Edge deployment.&quot;
            Timeout: 300
            TracingConfig:
                Mode: &quot;Active&quot;
            Role: !GetAtt &quot;EdgeDeployRole.Arn&quot;

    EdgeFunction:
        Type: &quot;AWS::CloudFormation::CustomResource&quot;
        Properties:
            # reference to deploy function
            ServiceToken: !GetAtt &quot;EdgeDeploy.Arn&quot;
            functionName: !Sub &quot;${AWS::Region}-edge&quot;
            # reference to destination role
            roleArn: !GetAtt &quot;EdgeFunctionRole.Arn&quot;
            handler: &quot;index.handler&quot;
            memory: 256
            timeout: 30
            packageBucket: &quot;your-bucket&quot;
            packageKey: &quot;your/lambda.zip&quot;
</pre></div></div></div>
        </div>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>Copyright &copy;2018&#x2013;2019
<a href="https://wrzasq.pl/">Rafał Wrzeszcz - Wrzasq.pl</a>.
All rights reserved.        <li id="publishDate" class="pull-right">Last Published: 2019-03-28</li>
          <li id="projectVersion" class="pull-right">Version: 1.0.6</li>
</p>
        </div>
        </div>
    </footer>
    </body>
</html>
