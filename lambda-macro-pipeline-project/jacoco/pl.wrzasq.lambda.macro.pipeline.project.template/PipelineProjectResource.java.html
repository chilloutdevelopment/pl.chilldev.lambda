<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PipelineProjectResource.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">WrzasqPl CodePipeline-CodeBuild automation macro</a> &gt; <a href="index.source.html" class="el_package">pl.wrzasq.lambda.macro.pipeline.project.template</a> &gt; <span class="el_source">PipelineProjectResource.java</span></div><h1>PipelineProjectResource.java</h1><pre class="source lang-java linenums">// Generated by delombok at Tue Jul 14 08:57:56 UTC 2020
/*
 * This file is part of the pl.wrzasq.lambda.
 *
 * @license http://mit-license.org/ The MIT license
 * @copyright 2020 © by Rafał Wrzeszcz - Wrzasq.pl.
 */
package pl.wrzasq.lambda.macro.pipeline.project.template;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import pl.wrzasq.commons.aws.cloudformation.macro.TemplateUtils;

/**
 * Model for handled resource.
 */
public class PipelineProjectResource {
    /**
     * Resource type identifier.
     */
    public static final String RESOURCE_TYPE = &quot;WrzasqPl::Pipeline::Project&quot;;
    /**
     * Default retention period for logs (in days).
     */
<span class="fc" id="L27">    private static final Number DEFAULT_LOGS_RETENTION_DAYS = 14;</span>
    /**
     * LogGroupName property name.
     */
    private static final String PROPERTY_LOG_GROUP_NAME = &quot;LogGroupName&quot;;
    /**
     * LogsRetentionInDays property name.
     */
    private static final String PROPERTY_LOGS_RETENTION_IN_DAYS = &quot;LogsRetentionInDays&quot;;
    /**
     * Artifacts property name.
     */
    private static final String PROPERTY_ARTIFACTS = &quot;Artifacts&quot;;
    /**
     * Source property name.
     */
    private static final String PROPERTY_SOURCE = &quot;Source&quot;;
    /**
     * Environment property name.
     */
    private static final String PROPERTY_ENVIRONMENT = &quot;Environment&quot;;
    /**
     * Property key &quot;Type&quot;.
     */
    private static final String PROPERTY_KEY_TYPE = &quot;Type&quot;;
    /**
     * Property key &quot;ComputeType&quot;.
     */
    private static final String PROPERTY_KEY_COMPUTE_TYPE = &quot;ComputeType&quot;;
    /**
     * Property key &quot;EnvironmentVariables&quot;.
     */
    private static final String PROPERTY_KEY_ENVIRONMENTVARIABLES = &quot;EnvironmentVariables&quot;;
    /**
     * Resource name.
     */
    private String logicalId;
    /**
     * Creation condition.
     */
    private String condition;

    /**
     * Builds definition of physical resources.
     *
     * @param properties Properties for our custom resource.
     * @return Definitions of all resources.
     */
    public Map&lt;String, Object&gt; buildDefinitions(Map&lt;String, Object&gt; properties) {
<span class="fc" id="L76">        var resources = new HashMap&lt;String, Object&gt;();</span>
        // generate all sub-resources
<span class="fc" id="L78">        this.createLogGroup(resources, properties);</span>
        // leave all properties as project properties
<span class="fc" id="L80">        this.createCodeBuildProject(resources, properties);</span>
<span class="fc" id="L81">        return resources;</span>
    }

    /**
     * Creates log group resource definition.
     *
     * @param resources Resources container.
     * @param properties Resource properties.
     */
    private void createLogGroup(Map&lt;String, Object&gt; resources, Map&lt;String, Object&gt; properties) {
        // default setup
<span class="fc" id="L92">        var resourceProperties = new HashMap&lt;String, Object&gt;();</span>
<span class="fc" id="L93">        resourceProperties.put(PipelineProjectResource.PROPERTY_LOG_GROUP_NAME, TemplateUtils.sub(String.format(&quot;/aws/codebuild/${%s}&quot;, this.logicalId)));</span>
<span class="fc" id="L94">        TemplateUtils.popProperty(properties, PipelineProjectResource.PROPERTY_LOGS_RETENTION_IN_DAYS, value -&gt; resourceProperties.put(&quot;RetentionInDays&quot;, value), PipelineProjectResource.DEFAULT_LOGS_RETENTION_DAYS);</span>
<span class="fc" id="L95">        this.generateResource(resources, &quot;LogGroup&quot;, &quot;Logs::LogGroup&quot;, resourceProperties);</span>
<span class="fc" id="L96">    }</span>

    /**
     * Creates project resource definition.
     *
     * @param resources Resources container.
     * @param properties Resource properties.
     */
    private void createCodeBuildProject(Map&lt;String, Object&gt; resources, Map&lt;String, Object&gt; properties) {
        // default setup for CodePipeline
<span class="fc" id="L106">        properties.computeIfAbsent(PipelineProjectResource.PROPERTY_ARTIFACTS, key -&gt; PipelineProjectResource.generateArtifactsDelegation());</span>
<span class="fc" id="L107">        properties.computeIfAbsent(PipelineProjectResource.PROPERTY_SOURCE, key -&gt; PipelineProjectResource.generateArtifactsDelegation());</span>
<span class="fc" id="L108">        var environment = TemplateUtils.asMap(properties.computeIfAbsent(PipelineProjectResource.PROPERTY_ENVIRONMENT, key -&gt; new HashMap&lt;&gt;()));</span>
<span class="fc" id="L109">        properties.put(PipelineProjectResource.PROPERTY_ENVIRONMENT, environment);</span>
        // sensible defaults for environment
<span class="fc" id="L111">        environment.putIfAbsent(PipelineProjectResource.PROPERTY_KEY_TYPE, &quot;LINUX_CONTAINER&quot;);</span>
<span class="fc" id="L112">        environment.putIfAbsent(PipelineProjectResource.PROPERTY_KEY_COMPUTE_TYPE, &quot;BUILD_GENERAL1_SMALL&quot;);</span>
<span class="pc" id="L113">        TemplateUtils.popProperty(properties, &quot;Variables&quot;, value -&gt; environment.put(PipelineProjectResource.PROPERTY_KEY_ENVIRONMENTVARIABLES, PipelineProjectResource.addMapToEntries(environment.computeIfAbsent(PipelineProjectResource.PROPERTY_KEY_ENVIRONMENTVARIABLES, key -&gt; new ArrayList&lt;&gt;()), value)), null);</span>
<span class="fc" id="L114">        this.generateResource(resources, &quot;&quot;, &quot;CodeBuild::Project&quot;, properties);</span>
<span class="fc" id="L115">    }</span>

    /**
     * Builds logical ID of LogGroup resource.
     *
     * @return LogGroup logical ID.
     */
    public String getLogGroupLogicalId() {
<span class="fc" id="L123">        return String.format(&quot;%sLogGroup&quot;, this.logicalId);</span>
    }

    /**
     * Adds resource to collection.
     *
     * @param resources Resources container.
     * @param suffix Resource logical ID suffix.
     * @param type CloudFormation resource type.
     * @param properties Resource configuration.
     */
    private void generateResource(Map&lt;String, Object&gt; resources, String suffix, String type, Map&lt;String, Object&gt; properties) {
<span class="fc" id="L135">        resources.put(String.format(&quot;%s%s&quot;, this.logicalId, suffix), TemplateUtils.generateResource(type, properties, this.condition));</span>
<span class="fc" id="L136">    }</span>

    /**
     * Generates artifacts reference for CodePipeline.
     *
     * @return CodePipeline setup for CodeBuild.
     */
    private static Map&lt;String, Object&gt; generateArtifactsDelegation() {
<span class="fc" id="L144">        var setup = new HashMap&lt;String, Object&gt;();</span>
<span class="fc" id="L145">        setup.put(PipelineProjectResource.PROPERTY_KEY_TYPE, &quot;CODEPIPELINE&quot;);</span>
<span class="fc" id="L146">        return setup;</span>
    }

    /**
     * Converts key-value mapping to list of entries.
     *
     * @param container Entries container.
     * @param map Key-value container.
     * @return List container.
     */
    private static List&lt;Object&gt; addMapToEntries(Object container, Object map) {
<span class="fc" id="L157">        var list = new ArrayList&lt;&gt;();</span>
<span class="pc bpc" id="L158" title="1 of 2 branches missed.">        if (container instanceof List) {</span>
<span class="fc" id="L159">            list.addAll((List&lt;?&gt;) container);</span>
        }
<span class="fc" id="L161">        TemplateUtils.asMap(map).forEach((key, value) -&gt; list.add(PipelineProjectResource.buildEnvironmentVariable(key, value)));</span>
<span class="fc" id="L162">        return list;</span>
    }

    /**
     * Builds CodeBuild environment variable definition.
     *
     * @param key Variable name.
     * @param value Variable value.
     * @return Variable entry.
     */
    private static Map&lt;String, Object&gt; buildEnvironmentVariable(String key, Object value) {
<span class="fc" id="L173">        var container = new HashMap&lt;String, Object&gt;();</span>
<span class="fc" id="L174">        container.put(&quot;Name&quot;, key);</span>
<span class="fc" id="L175">        container.put(&quot;Value&quot;, value);</span>
<span class="fc" id="L176">        return container;</span>
    }

    @SuppressWarnings(&quot;all&quot;)
    @lombok.Generated
    public PipelineProjectResource(final String logicalId, final String condition) {
        this.logicalId = logicalId;
        this.condition = condition;
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>