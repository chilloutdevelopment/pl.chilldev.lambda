<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LambdaFunctionResource.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">WrzasqPl CloudFormation Lambda function macro</a> &gt; <a href="index.source.html" class="el_package">pl.wrzasq.lambda.macro.lambda.function.template</a> &gt; <span class="el_source">LambdaFunctionResource.java</span></div><h1>LambdaFunctionResource.java</h1><pre class="source lang-java linenums">// Generated by delombok at Tue Oct 15 07:13:37 UTC 2019
/*
 * This file is part of the pl.wrzasq.lambda.
 *
 * @license http://mit-license.org/ The MIT license
 * @copyright 2019 © by Rafał Wrzeszcz - Wrzasq.pl.
 */
package pl.wrzasq.lambda.macro.lambda.function.template;

import java.util.Collections;
import java.util.HashMap;
import java.util.Map;
import java.util.function.Consumer;

/**
 * Model for handled resource.
 */
public class LambdaFunctionResource {
    /**
     * Resource type identifier.
     */
    public static final String RESOURCE_TYPE = &quot;WrzasqPl::Lambda::Function&quot;;
    /**
     * Metrics namespace.
     */
    private static final String METRICS_NAMESPACE = &quot;WrzasqPl/Lambda&quot;;
    /**
     * Default retention period for logs (in days).
     */
<span class="fc" id="L30">    private static final Number DEFAULT_LOGS_RETENTION_DAYS = 7;</span>
    /**
     * Default alarm check period (in seconds).
     */
<span class="fc" id="L34">    private static final Number DEFAULT_ALERT_PERIOD = 300;</span>
    /**
     * Value used for counting metrics (each metric record is single occurange).
     */
    private static final String COUNTER_METRIC_VALUE = &quot;1&quot;;
    /**
     * LogGroupName property name.
     */
    private static final String PROPERTY_LOG_GROUP_NAME = &quot;LogGroupName&quot;;
    /**
     * LogsRetentionInDays property name.
     */
    private static final String PROPERTY_LOGS_RETENTION_IN_DAYS = &quot;LogsRetentionInDays&quot;;
    /**
     * Namespace property name.
     */
    private static final String PROPERTY_NAMESPACE = &quot;Namespace&quot;;
    /**
     * MetricName property name.
     */
    private static final String PROPERTY_METRIC_NAME = &quot;MetricName&quot;;
    /**
     * Statistic property name.
     */
    private static final String PROPERTY_STATISTIC = &quot;Statistic&quot;;
    /**
     * ComparisonOperator property name.
     */
    private static final String PROPERTY_COMPARISON_OPERATOR = &quot;ComparisonOperator&quot;;
    /**
     * Threshold property name.
     */
    private static final String PROPERTY_THRESHOLD = &quot;Threshold&quot;;
    /**
     * EvaluationPeriods property name.
     */
    private static final String PROPERTY_EVALUATION_PERIODS = &quot;EvaluationPeriods&quot;;
    /**
     * Period property name.
     */
    private static final String PROPERTY_PERIOD = &quot;Period&quot;;
    /**
     * TreatMissingData property name.
     */
    private static final String PROPERTY_TREAT_MISSING_DATA = &quot;TreatMissingData&quot;;
    /**
     * MetricValue property name.
     */
    private static final String PROPERTY_METRIC_VALUE = &quot;MetricValue&quot;;
    /**
     * MetricNamespace property name.
     */
    private static final String PROPERTY_METRIC_NAMESPACE = &quot;MetricNamespace&quot;;
    /**
     * MetricTransformations property name.
     */
    private static final String PROPERTY_METRIC_TRANSFORMATIONS = &quot;MetricTransformations&quot;;
    /**
     * FilterPattern property name.
     */
    private static final String PROPERTY_FILTER_PATTERN = &quot;FilterPattern&quot;;
    /**
     * Resource name.
     */
    private String logicalId;

    /**
     * Builds definition of physical resources.
     *
     * @param properties Properties for our custom resource.
     * @return Definitions of all resources.
     */
    public Map&lt;String, Object&gt; buildDefinitions(Map&lt;String, Object&gt; properties) {
<span class="fc" id="L107">        Map&lt;String, Object&gt; resources = new HashMap&lt;&gt;();</span>
        // generate all sub-resources
<span class="fc" id="L109">        this.createLogGroup(resources, properties);</span>
<span class="fc" id="L110">        this.createMemoryMetricFilter(resources);</span>
<span class="fc" id="L111">        this.createErrorsMetricFilter(resources, properties);</span>
<span class="fc" id="L112">        this.createErrorsAlarm(resources, properties);</span>
<span class="fc" id="L113">        this.createWarningsMetricFilter(resources, properties);</span>
        // leave all properties as function properties
<span class="fc" id="L115">        this.createLambdaFunction(resources, properties);</span>
<span class="fc" id="L116">        return resources;</span>
    }

    /**
     * Creates log group resource definition.
     *
     * @param resources Resources container.
     * @param properties Resource properties.
     */
    private void createLogGroup(Map&lt;String, Object&gt; resources, Map&lt;String, Object&gt; properties) {
        // default setup
<span class="fc" id="L127">        Map&lt;String, Object&gt; resourceProperties = new HashMap&lt;&gt;();</span>
<span class="fc" id="L128">        resourceProperties.put(LambdaFunctionResource.PROPERTY_LOG_GROUP_NAME, LambdaFunctionResource.sub(String.format(&quot;/aws/lambda/${%s}&quot;, this.logicalId)));</span>
<span class="fc" id="L129">        LambdaFunctionResource.popProperty(properties, LambdaFunctionResource.PROPERTY_LOGS_RETENTION_IN_DAYS, (Object value) -&gt; resourceProperties.put(&quot;RetentionInDays&quot;, value), LambdaFunctionResource.DEFAULT_LOGS_RETENTION_DAYS);</span>
<span class="fc" id="L130">        this.generateResource(resources, &quot;LogGroup&quot;, &quot;Logs::LogGroup&quot;, resourceProperties);</span>
<span class="fc" id="L131">    }</span>

    /**
     * Creates memory metric filter resource definition.
     *
     * @param resources Resources container.
     */
    private void createMemoryMetricFilter(Map&lt;String, Object&gt; resources) {
<span class="fc" id="L139">        this.createMetricFilter(resources, &quot;MemoryMetricFilter&quot;, &quot;Memory&quot;, &quot;$max_memory_used&quot;, &quot;[label=\&quot;REPORT\&quot;, ..., memory_label=\&quot;Used:\&quot;, max_memory_used, unit=\&quot;MB\&quot;, xray_label=\&quot;XRAY\&quot;, trace_label=\&quot;TraceId:\&quot;, traced, segment_label=\&quot;SegmentId:\&quot;, segment]&quot;);</span>
<span class="fc" id="L140">    }</span>

    /**
     * Creates errors metric filter resource definition.
     *
     * @param resources Resources container.
     * @param properties Resource properties.
     */
    private void createErrorsMetricFilter(Map&lt;String, Object&gt; resources, Map&lt;String, Object&gt; properties) {
<span class="fc" id="L149">        LambdaFunctionResource.popProperty(properties, &quot;ErrorsFilterPattern&quot;, (Object filter) -&gt; this.createMetricFilter(resources, &quot;ErrorsMetricFilter&quot;, &quot;Errors&quot;, LambdaFunctionResource.COUNTER_METRIC_VALUE, filter), &quot;ERROR -LOG_ERROR&quot;);</span>
<span class="fc" id="L150">    }</span>

    /**
     * Creates errors alarm resource definition.
     *
     * @param resources Resources container.
     * @param properties Resource properties.
     */
    private void createErrorsAlarm(Map&lt;String, Object&gt; resources, Map&lt;String, Object&gt; properties) {
<span class="fc" id="L159">        Map&lt;String, Object&gt; resourceProperties = new HashMap&lt;&gt;();</span>
<span class="fc" id="L160">        resourceProperties.put(LambdaFunctionResource.PROPERTY_NAMESPACE, LambdaFunctionResource.METRICS_NAMESPACE);</span>
<span class="fc" id="L161">        resourceProperties.put(LambdaFunctionResource.PROPERTY_METRIC_NAME, LambdaFunctionResource.sub(String.format(&quot;${%s}-Errors&quot;, this.logicalId)));</span>
<span class="fc" id="L162">        resourceProperties.put(LambdaFunctionResource.PROPERTY_STATISTIC, &quot;Sum&quot;);</span>
<span class="fc" id="L163">        resourceProperties.put(LambdaFunctionResource.PROPERTY_COMPARISON_OPERATOR, &quot;GreaterThanThreshold&quot;);</span>
<span class="fc" id="L164">        resourceProperties.put(LambdaFunctionResource.PROPERTY_THRESHOLD, 0);</span>
<span class="fc" id="L165">        resourceProperties.put(LambdaFunctionResource.PROPERTY_EVALUATION_PERIODS, 1);</span>
<span class="fc" id="L166">        resourceProperties.put(LambdaFunctionResource.PROPERTY_PERIOD, LambdaFunctionResource.DEFAULT_ALERT_PERIOD);</span>
<span class="fc" id="L167">        resourceProperties.put(LambdaFunctionResource.PROPERTY_TREAT_MISSING_DATA, &quot;notBreaching&quot;);</span>
<span class="fc" id="L168">        LambdaFunctionResource.popProperty(properties, &quot;ErrorsAlarmActions&quot;, (Object value) -&gt; resourceProperties.put(&quot;AlarmActions&quot;, value), null);</span>
<span class="fc" id="L169">        this.generateResource(resources, &quot;ErrorsAlarm&quot;, &quot;CloudWatch::Alarm&quot;, resourceProperties);</span>
<span class="fc" id="L170">    }</span>

    /**
     * Creates warnings metric filter resource definition.
     *
     * @param resources Resources container.
     * @param properties Resource properties.
     */
    private void createWarningsMetricFilter(Map&lt;String, Object&gt; resources, Map&lt;String, Object&gt; properties) {
<span class="fc" id="L179">        LambdaFunctionResource.popProperty(properties, &quot;WarningsFilterPattern&quot;, (Object filter) -&gt; this.createMetricFilter(resources, &quot;WarningsMetricFilter&quot;, &quot;Warnings&quot;, LambdaFunctionResource.COUNTER_METRIC_VALUE, filter), &quot;WARN&quot;);</span>
<span class="fc" id="L180">    }</span>

    /**
     * Generic method for metric filter creation.
     *
     * @param resources Resources container.
     * @param resourceName Resource logical ID.
     * @param metricNameSuffix Metric name postfix.
     * @param metricValue Metric value.
     * @param filterPattern Metric log filter pattern.
     */
    private void createMetricFilter(Map&lt;String, Object&gt; resources, String resourceName, String metricNameSuffix, String metricValue, Object filterPattern) {
<span class="fc" id="L192">        Map&lt;String, Object&gt; transformation = new HashMap&lt;&gt;();</span>
<span class="fc" id="L193">        transformation.put(LambdaFunctionResource.PROPERTY_METRIC_NAMESPACE, LambdaFunctionResource.METRICS_NAMESPACE);</span>
<span class="fc" id="L194">        transformation.put(LambdaFunctionResource.PROPERTY_METRIC_NAME, LambdaFunctionResource.sub(String.format(&quot;${%s}-%s&quot;, this.logicalId, metricNameSuffix)));</span>
<span class="fc" id="L195">        transformation.put(LambdaFunctionResource.PROPERTY_METRIC_VALUE, metricValue);</span>
<span class="fc" id="L196">        Map&lt;String, Object&gt; resourceProperties = new HashMap&lt;&gt;();</span>
<span class="fc" id="L197">        resourceProperties.put(LambdaFunctionResource.PROPERTY_LOG_GROUP_NAME, LambdaFunctionResource.ref(this.getLogGroupLogicalId()));</span>
<span class="fc" id="L198">        resourceProperties.put(LambdaFunctionResource.PROPERTY_METRIC_TRANSFORMATIONS, Collections.singletonList(transformation));</span>
        // note that this is not a string - it may be defined as a CloudFormation function call!
<span class="fc" id="L200">        resourceProperties.put(LambdaFunctionResource.PROPERTY_FILTER_PATTERN, filterPattern);</span>
<span class="fc" id="L201">        this.generateResource(resources, resourceName, &quot;Logs::MetricFilter&quot;, resourceProperties);</span>
<span class="fc" id="L202">    }</span>

    /**
     * Creates function resource definition.
     *
     * @param resources Resources container.
     * @param properties Resource properties.
     */
    private void createLambdaFunction(Map&lt;String, Object&gt; resources, Map&lt;String, Object&gt; properties) {
<span class="fc" id="L211">        this.generateResource(resources, &quot;&quot;, &quot;Lambda::Function&quot;, properties);</span>
<span class="fc" id="L212">    }</span>

    /**
     * Builds logical ID of LogGroup resource.
     *
     * @return LogGroup logical ID.
     */
    public String getLogGroupLogicalId() {
<span class="fc" id="L220">        return String.format(&quot;%sLogGroup&quot;, this.logicalId);</span>
    }

    /**
     * Adds resource to collection.
     *
     * @param resources Resources container.
     * @param suffix Resource logical ID suffix.
     * @param type CloudFormation resource type.
     * @param properties Resource configuration.
     */
    private void generateResource(Map&lt;String, Object&gt; resources, String suffix, String type, Map&lt;String, Object&gt; properties) {
<span class="fc" id="L232">        Map&lt;String, Object&gt; resource = new HashMap&lt;&gt;();</span>
<span class="fc" id="L233">        resource.put(&quot;Type&quot;, String.format(&quot;AWS::%s&quot;, type));</span>
<span class="fc bfc" id="L234" title="All 2 branches covered.">        if (!properties.isEmpty()) {</span>
<span class="fc" id="L235">            resource.put(&quot;Properties&quot;, properties);</span>
        }
<span class="fc" id="L237">        resources.put(String.format(&quot;%s%s&quot;, this.logicalId, suffix), resource);</span>
<span class="fc" id="L238">    }</span>

    /**
     * Handles optional property by removing it from generic properties pool.
     *
     * @param properties Main properties container.
     * @param key Property key.
     * @param then Property action.
     * @param defaultValue Default property value.
     */
    private static void popProperty(Map&lt;String, Object&gt; properties, String key, Consumer&lt;Object&gt; then, Object defaultValue) {
<span class="fc bfc" id="L249" title="All 2 branches covered.">        if (properties.containsKey(key)) {</span>
<span class="fc" id="L250">            then.accept(properties.get(key));</span>
<span class="fc" id="L251">            properties.remove(key);</span>
<span class="fc bfc" id="L252" title="All 2 branches covered.">        } else if (defaultValue != null) {</span>
<span class="fc" id="L253">            then.accept(defaultValue);</span>
        }
<span class="fc" id="L255">    }</span>

    /**
     * Returns !Ref reference call.
     *
     * @param reference Referred object ID.
     * @return !Ref call.
     */
    private static Object ref(String reference) {
<span class="fc" id="L264">        return Collections.singletonMap(&quot;Ref&quot;, reference);</span>
    }

    /**
     * Returns !Sub reference call.
     *
     * @param params Call parameters.
     * @return !Sub call.
     */
    private static Object sub(Object params) {
<span class="fc" id="L274">        return Collections.singletonMap(&quot;Fn::Sub&quot;, params);</span>
    }

    @SuppressWarnings(&quot;all&quot;)
    @lombok.Generated
    public LambdaFunctionResource(final String logicalId) {
        this.logicalId = logicalId;
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>