<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LambdaFunctionResource.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">WrzasqPl CloudFormation Lambda function macro</a> &gt; <a href="index.source.html" class="el_package">pl.wrzasq.lambda.macro.lambda.function.template</a> &gt; <span class="el_source">LambdaFunctionResource.java</span></div><h1>LambdaFunctionResource.java</h1><pre class="source lang-java linenums">// Generated by delombok at Wed Jun 03 06:30:23 UTC 2020
/*
 * This file is part of the pl.wrzasq.lambda.
 *
 * @license http://mit-license.org/ The MIT license
 * @copyright 2019 - 2020 © by Rafał Wrzeszcz - Wrzasq.pl.
 */
package pl.wrzasq.lambda.macro.lambda.function.template;

import java.util.Collections;
import java.util.HashMap;
import java.util.Map;
import pl.wrzasq.commons.aws.cloudformation.macro.TemplateUtils;

/**
 * Model for handled resource.
 */
public class LambdaFunctionResource {
    /**
     * Resource type identifier.
     */
    public static final String LAMBDA_RESOURCE_TYPE = &quot;WrzasqPl::Lambda::Function&quot;;
    /**
     * Serverless resource type identifier.
     */
    public static final String SERVERLESS_RESOURCE_TYPE = &quot;WrzasqPl::Serverless::Function&quot;;
    /**
     * Metrics namespace.
     */
    private static final String METRICS_NAMESPACE = &quot;WrzasqPl/Lambda&quot;;
    /**
     * Default retention period for logs (in days).
     */
<span class="fc" id="L34">    private static final Number DEFAULT_LOGS_RETENTION_DAYS = 7;</span>
    /**
     * Default alarm check period (in seconds).
     */
<span class="fc" id="L38">    private static final Number DEFAULT_ALERT_PERIOD = 300;</span>
    /**
     * Value used for counting metrics (each metric record is single occurrence).
     */
    private static final String COUNTER_METRIC_VALUE = &quot;1&quot;;
    /**
     * LogGroupName property name.
     */
    private static final String PROPERTY_LOG_GROUP_NAME = &quot;LogGroupName&quot;;
    /**
     * LogsRetentionInDays property name.
     */
    private static final String PROPERTY_LOGS_RETENTION_IN_DAYS = &quot;LogsRetentionInDays&quot;;
    /**
     * Namespace property name.
     */
    private static final String PROPERTY_NAMESPACE = &quot;Namespace&quot;;
    /**
     * MetricName property name.
     */
    private static final String PROPERTY_METRIC_NAME = &quot;MetricName&quot;;
    /**
     * Statistic property name.
     */
    private static final String PROPERTY_STATISTIC = &quot;Statistic&quot;;
    /**
     * ComparisonOperator property name.
     */
    private static final String PROPERTY_COMPARISON_OPERATOR = &quot;ComparisonOperator&quot;;
    /**
     * Threshold property name.
     */
    private static final String PROPERTY_THRESHOLD = &quot;Threshold&quot;;
    /**
     * EvaluationPeriods property name.
     */
    private static final String PROPERTY_EVALUATION_PERIODS = &quot;EvaluationPeriods&quot;;
    /**
     * Period property name.
     */
    private static final String PROPERTY_PERIOD = &quot;Period&quot;;
    /**
     * TreatMissingData property name.
     */
    private static final String PROPERTY_TREAT_MISSING_DATA = &quot;TreatMissingData&quot;;
    /**
     * MetricValue property name.
     */
    private static final String PROPERTY_METRIC_VALUE = &quot;MetricValue&quot;;
    /**
     * MetricNamespace property name.
     */
    private static final String PROPERTY_METRIC_NAMESPACE = &quot;MetricNamespace&quot;;
    /**
     * MetricTransformations property name.
     */
    private static final String PROPERTY_METRIC_TRANSFORMATIONS = &quot;MetricTransformations&quot;;
    /**
     * FilterPattern property name.
     */
    private static final String PROPERTY_FILTER_PATTERN = &quot;FilterPattern&quot;;
    /**
     * Resource name.
     */
    private String logicalId;
    /**
     * Resource mode (`Lambda` or `Serverless`).
     */
    private String mode;

    /**
     * Builds definition of physical resources.
     *
     * @param properties Properties for our custom resource.
     * @return Definitions of all resources.
     */
    public Map&lt;String, Object&gt; buildDefinitions(Map&lt;String, Object&gt; properties) {
<span class="fc" id="L115">        var resources = new HashMap&lt;String, Object&gt;();</span>
        // generate all sub-resources
<span class="fc" id="L117">        this.createLogGroup(resources, properties);</span>
<span class="fc" id="L118">        this.createMemoryMetricFilter(resources);</span>
<span class="fc" id="L119">        this.createErrorsMetricFilter(resources, properties);</span>
<span class="fc" id="L120">        this.createErrorsAlarm(resources, properties);</span>
<span class="fc" id="L121">        this.createWarningsMetricFilter(resources, properties);</span>
        // leave all properties as function properties
<span class="fc" id="L123">        this.createLambdaFunction(resources, properties);</span>
<span class="fc" id="L124">        return resources;</span>
    }

    /**
     * Creates log group resource definition.
     *
     * @param resources Resources container.
     * @param properties Resource properties.
     */
    private void createLogGroup(Map&lt;String, Object&gt; resources, Map&lt;String, Object&gt; properties) {
        // default setup
<span class="fc" id="L135">        var resourceProperties = new HashMap&lt;String, Object&gt;();</span>
<span class="fc" id="L136">        resourceProperties.put(LambdaFunctionResource.PROPERTY_LOG_GROUP_NAME, TemplateUtils.sub(String.format(&quot;/aws/lambda/${%s}&quot;, this.logicalId)));</span>
<span class="fc" id="L137">        TemplateUtils.popProperty(properties, LambdaFunctionResource.PROPERTY_LOGS_RETENTION_IN_DAYS, value -&gt; resourceProperties.put(&quot;RetentionInDays&quot;, value), LambdaFunctionResource.DEFAULT_LOGS_RETENTION_DAYS);</span>
<span class="fc" id="L138">        this.generateResource(resources, &quot;LogGroup&quot;, &quot;Logs::LogGroup&quot;, resourceProperties);</span>
<span class="fc" id="L139">    }</span>

    /**
     * Creates memory metric filter resource definition.
     *
     * @param resources Resources container.
     */
    private void createMemoryMetricFilter(Map&lt;String, Object&gt; resources) {
<span class="fc" id="L147">        this.createMetricFilter(resources, &quot;MemoryMetricFilter&quot;, &quot;Memory&quot;, &quot;$max_memory_used&quot;, &quot;[label=\&quot;REPORT\&quot;, ..., memory_label=\&quot;Used:\&quot;, max_memory_used, unit=\&quot;MB\&quot;, xray_label=\&quot;XRAY\&quot;, trace_label=\&quot;TraceId:\&quot;, traced, segment_label=\&quot;SegmentId:\&quot;, segment, sampled_label=\&quot;Sampled:\&quot;, sampled_value]&quot;);</span>
<span class="fc" id="L148">    }</span>

    /**
     * Creates errors metric filter resource definition.
     *
     * @param resources Resources container.
     * @param properties Resource properties.
     */
    private void createErrorsMetricFilter(Map&lt;String, Object&gt; resources, Map&lt;String, Object&gt; properties) {
<span class="fc" id="L157">        TemplateUtils.popProperty(properties, &quot;ErrorsFilterPattern&quot;, filter -&gt; this.createMetricFilter(resources, &quot;ErrorsMetricFilter&quot;, &quot;Errors&quot;, LambdaFunctionResource.COUNTER_METRIC_VALUE, filter), &quot;ERROR -LOG_ERROR&quot;);</span>
<span class="fc" id="L158">    }</span>

    /**
     * Creates errors alarm resource definition.
     *
     * @param resources Resources container.
     * @param properties Resource properties.
     */
    private void createErrorsAlarm(Map&lt;String, Object&gt; resources, Map&lt;String, Object&gt; properties) {
<span class="fc" id="L167">        var resourceProperties = new HashMap&lt;String, Object&gt;();</span>
<span class="fc" id="L168">        resourceProperties.put(LambdaFunctionResource.PROPERTY_NAMESPACE, LambdaFunctionResource.METRICS_NAMESPACE);</span>
<span class="fc" id="L169">        resourceProperties.put(LambdaFunctionResource.PROPERTY_METRIC_NAME, TemplateUtils.sub(String.format(&quot;${%s}-Errors&quot;, this.logicalId)));</span>
<span class="fc" id="L170">        resourceProperties.put(LambdaFunctionResource.PROPERTY_STATISTIC, &quot;Sum&quot;);</span>
<span class="fc" id="L171">        resourceProperties.put(LambdaFunctionResource.PROPERTY_COMPARISON_OPERATOR, &quot;GreaterThanThreshold&quot;);</span>
<span class="fc" id="L172">        resourceProperties.put(LambdaFunctionResource.PROPERTY_THRESHOLD, 0);</span>
<span class="fc" id="L173">        resourceProperties.put(LambdaFunctionResource.PROPERTY_EVALUATION_PERIODS, 1);</span>
<span class="fc" id="L174">        resourceProperties.put(LambdaFunctionResource.PROPERTY_PERIOD, LambdaFunctionResource.DEFAULT_ALERT_PERIOD);</span>
<span class="fc" id="L175">        resourceProperties.put(LambdaFunctionResource.PROPERTY_TREAT_MISSING_DATA, &quot;notBreaching&quot;);</span>
<span class="fc" id="L176">        TemplateUtils.popProperty(properties, &quot;ErrorsAlarmActions&quot;, value -&gt; resourceProperties.put(&quot;AlarmActions&quot;, value), null);</span>
<span class="fc" id="L177">        this.generateResource(resources, &quot;ErrorsAlarm&quot;, &quot;CloudWatch::Alarm&quot;, resourceProperties);</span>
<span class="fc" id="L178">    }</span>

    /**
     * Creates warnings metric filter resource definition.
     *
     * @param resources Resources container.
     * @param properties Resource properties.
     */
    private void createWarningsMetricFilter(Map&lt;String, Object&gt; resources, Map&lt;String, Object&gt; properties) {
<span class="fc" id="L187">        TemplateUtils.popProperty(properties, &quot;WarningsFilterPattern&quot;, filter -&gt; this.createMetricFilter(resources, &quot;WarningsMetricFilter&quot;, &quot;Warnings&quot;, LambdaFunctionResource.COUNTER_METRIC_VALUE, filter), &quot;WARN&quot;);</span>
<span class="fc" id="L188">    }</span>

    /**
     * Generic method for metric filter creation.
     *
     * @param resources Resources container.
     * @param resourceName Resource logical ID.
     * @param metricNameSuffix Metric name postfix.
     * @param metricValue Metric value.
     * @param filterPattern Metric log filter pattern.
     */
    private void createMetricFilter(Map&lt;String, Object&gt; resources, String resourceName, String metricNameSuffix, String metricValue, Object filterPattern) {
<span class="fc" id="L200">        var transformation = new HashMap&lt;&gt;();</span>
<span class="fc" id="L201">        transformation.put(LambdaFunctionResource.PROPERTY_METRIC_NAMESPACE, LambdaFunctionResource.METRICS_NAMESPACE);</span>
<span class="fc" id="L202">        transformation.put(LambdaFunctionResource.PROPERTY_METRIC_NAME, TemplateUtils.sub(String.format(&quot;${%s}-%s&quot;, this.logicalId, metricNameSuffix)));</span>
<span class="fc" id="L203">        transformation.put(LambdaFunctionResource.PROPERTY_METRIC_VALUE, metricValue);</span>
<span class="fc" id="L204">        var resourceProperties = new HashMap&lt;String, Object&gt;();</span>
<span class="fc" id="L205">        resourceProperties.put(LambdaFunctionResource.PROPERTY_LOG_GROUP_NAME, TemplateUtils.ref(this.getLogGroupLogicalId()));</span>
<span class="fc" id="L206">        resourceProperties.put(LambdaFunctionResource.PROPERTY_METRIC_TRANSFORMATIONS, Collections.singletonList(transformation));</span>
        // note that this is not a string - it may be defined as a CloudFormation function call!
<span class="fc" id="L208">        resourceProperties.put(LambdaFunctionResource.PROPERTY_FILTER_PATTERN, filterPattern);</span>
<span class="fc" id="L209">        this.generateResource(resources, resourceName, &quot;Logs::MetricFilter&quot;, resourceProperties);</span>
<span class="fc" id="L210">    }</span>

    /**
     * Creates function resource definition.
     *
     * @param resources Resources container.
     * @param properties Resource properties.
     */
    private void createLambdaFunction(Map&lt;String, Object&gt; resources, Map&lt;String, Object&gt; properties) {
<span class="fc" id="L219">        this.generateResource(resources, &quot;&quot;, String.format(&quot;%s::Function&quot;, this.mode), properties);</span>
<span class="fc" id="L220">    }</span>

    /**
     * Builds logical ID of LogGroup resource.
     *
     * @return LogGroup logical ID.
     */
    public String getLogGroupLogicalId() {
<span class="fc" id="L228">        return String.format(&quot;%sLogGroup&quot;, this.logicalId);</span>
    }

    /**
     * Adds resource to collection.
     *
     * @param resources Resources container.
     * @param suffix Resource logical ID suffix.
     * @param type CloudFormation resource type.
     * @param properties Resource configuration.
     */
    private void generateResource(Map&lt;String, Object&gt; resources, String suffix, String type, Map&lt;String, Object&gt; properties) {
<span class="fc" id="L240">        resources.put(String.format(&quot;%s%s&quot;, this.logicalId, suffix), TemplateUtils.generateResource(type, properties, null));</span>
<span class="fc" id="L241">    }</span>

    @SuppressWarnings(&quot;all&quot;)
    @lombok.Generated
    public LambdaFunctionResource(final String logicalId, final String mode) {
        this.logicalId = logicalId;
        this.mode = mode;
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>